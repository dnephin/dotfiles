meta:
  project: centrifuge

mount=source:
  bind: .
  path: /go/src/github.com/circleci/centrifuge

mount=depsources:
  bind: ./.depsources
  path: /go/pkg/dep/sources

mount=sshagent:
  bind: "{env.SSH_AUTH_SOCK}"
  path: /tmp/sshagent.sock

image=builder:
  image: centrifuge-dev
  context: dobifiles/
  dockerfile: Dockerfile.dev

job=shell:
  use: builder
  mounts: [source, depsources, sshagent]
  env: [SSH_AUTH_SOCK=/tmp/sshagent.sock]
  provide-docker: true
  net-mode: host
  interactive: true
  command: sh

job=watch:
  use: builder
  mounts: [source]
  provide-docker: true
  interactive: true
  net-mode: host
  command: |
    filewatcher -x vendor gotestsum -- -tags=integration -timeout=10s
  env:
    - 'GOTESTSUM_FORMAT=short-verbose'
    - 'NOMAD_ADDR={env.NOMAD_ADDR:}'
    - 'AWS_ACCESS_KEY_ID={env.AWS_ACCESS_KEY_ID:}'
    - 'AWS_SECRET_ACCESS_KEY={env.AWS_SECRET_ACCESS_KEY:}'
    - 'AWS_REGION={env.AWS_REGION:}'

job=deps:
  use: builder
  mounts: [source, depsources, sshagent]
  env: [SSH_AUTH_SOCK=/tmp/sshagent.sock]
  command: dep ensure

job=lint:
  use: builder
  mounts: [source]
  command: gometalinter ./...
